#!/usr/bin/env bash
# verify-snapshot - Check a snapshot for potentially missed secrets
set -euo pipefail

SNAPSHOT="${1:?Usage: $0 <snapshot-directory>}"

if [ ! -d "$SNAPSHOT" ]; then
  echo "Error: Directory not found: $SNAPSHOT"
  exit 1
fi

echo "==> Scanning snapshot for potential secrets: $SNAPSHOT"
echo

# Patterns that might indicate secrets (case-insensitive grep)
PATTERNS=(
  # Common secret env vars
  "export.*SECRET"
  "export.*TOKEN"
  "export.*PASSWORD"
  "export.*API[_-]KEY"
  
  # AWS patterns
  "AKIA[0-9A-Z]{16}"
  "aws_secret_access_key"
  
  # GitHub tokens
  "gh[pousr]_[A-Za-z0-9_]{36,255}"
  
  # Generic API patterns
  "api[_-]key.*['\"]?[A-Za-z0-9]{20,}"
  "bearer.*[A-Za-z0-9_-]{20,}"
  
  # Private keys that might have slipped through
  "BEGIN.*PRIVATE.*KEY"
  "BEGIN RSA PRIVATE KEY"
  "BEGIN OPENSSH PRIVATE KEY"
  
  # Common tokens
  "npm_[A-Za-z0-9]{36}"
  "sk-[A-Za-z0-9]{32,}"  # OpenAI-style keys
)

FOUND=0

for pattern in "${PATTERNS[@]}"; do
  # Use grep with context, ignore binary files
  if grep -riI -n --color=auto "$pattern" "$SNAPSHOT" 2>/dev/null; then
    FOUND=1
    echo "  ^ Found pattern: $pattern"
    echo
  fi
done

echo
if [ $FOUND -eq 0 ]; then
  echo "✓ No obvious secrets found (but manual review is still recommended)"
  exit 0
else
  echo "⚠️  Potential secrets detected above - REVIEW CAREFULLY before sharing"
  exit 1
fi
