#!/usr/bin/env bash

# Quick restore helper - guides you through restoration
# Copyright (C) 2025 Unstable Studios

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.

# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

SNAPSHOT="${1:?Usage: $0 <snapshot-directory>}"

if [ ! -d "$SNAPSHOT" ]; then
  echo "Error: Directory not found: $SNAPSHOT"
  exit 1
fi

echo "==> Dev Config Restore Helper"
echo
echo "Snapshot: $SNAPSHOT"
echo

if [ -f "$SNAPSHOT/metadata.txt" ]; then
  echo "Snapshot metadata:"
  cat "$SNAPSHOT/metadata.txt"
  echo
fi

echo "This script will guide you through restoration."
echo "You can skip any step that doesn't apply to your setup."
echo

# Helper function to ask yes/no
ask() {
  local prompt="$1"
  local response
  read -p "$prompt [y/N]: " response
  [[ "$response" =~ ^[Yy]$ ]]
}

# 1. Homebrew
if [ -f "$SNAPSHOT/brew/Brewfile" ]; then
  echo "==> Homebrew Brewfile found"
  if ask "Install Homebrew packages from Brewfile?"; then
    if command -v brew >/dev/null 2>&1; then
      brew bundle install --file "$SNAPSHOT/brew/Brewfile"
    else
      echo "Homebrew not installed. Install from: https://brew.sh"
    fi
  fi
  echo
fi

# 2. Git config
if [ -f "$SNAPSHOT/git/files/.gitconfig" ]; then
  echo "==> Git config found"
  if ask "Copy .gitconfig to ~/.gitconfig?"; then
    cp "$SNAPSHOT/git/files/.gitconfig" ~/.gitconfig
    echo "✓ Copied"
  fi
  echo
fi

# 3. SSH config
if [ -f "$SNAPSHOT/ssh/config" ]; then
  echo "==> SSH config found"
  if ask "Copy SSH config to ~/.ssh/config?"; then
    mkdir -p ~/.ssh
    cp "$SNAPSHOT/ssh/config" ~/.ssh/config
    chmod 600 ~/.ssh/config
    echo "✓ Copied and permissions set"
  fi
  echo
fi

# 4. Shell essence
if [ -f "$SNAPSHOT/shell/essence/zshrc-essence.md" ]; then
  echo "==> Zsh essence guide found"
  echo "Review this file for your .zshrc rebuild recipe:"
  echo "  $SNAPSHOT/shell/essence/zshrc-essence.md"
  echo
  if ask "Open it now?"; then
    ${EDITOR:-less} "$SNAPSHOT/shell/essence/zshrc-essence.md"
  fi
  echo
fi

# 5. VS Code extensions
if [ -f "$SNAPSHOT/vscode/extensions.txt" ]; then
  echo "==> VS Code extensions list found"
  if ask "Install VS Code extensions?"; then
    if command -v code >/dev/null 2>&1; then
      cat "$SNAPSHOT/vscode/extensions.txt" | xargs -L 1 code --install-extension
      echo "✓ Extensions installed"
    else
      echo "VS Code CLI not available. Install manually or add 'code' to PATH"
    fi
  fi
  echo
fi

# 6. VS Code settings
if [ -f "$SNAPSHOT/vscode/settings.json" ]; then
  echo "==> VS Code settings found"
  if ask "Copy VS Code settings?"; then
    VSCODE_USER="$HOME/Library/Application Support/Code/User"
    mkdir -p "$VSCODE_USER"
    cp "$SNAPSHOT/vscode/settings.json" "$VSCODE_USER/"
    [ -f "$SNAPSHOT/vscode/keybindings.json" ] && cp "$SNAPSHOT/vscode/keybindings.json" "$VSCODE_USER/"
    [ -d "$SNAPSHOT/vscode/snippets" ] && cp -r "$SNAPSHOT/vscode/snippets" "$VSCODE_USER/"
    echo "✓ Copied"
  fi
  echo
fi

# 7. Tmux
if [ -f "$SNAPSHOT/tmux/.tmux.conf" ]; then
  echo "==> Tmux config found"
  if ask "Copy .tmux.conf to ~/.tmux.conf?"; then
    cp "$SNAPSHOT/tmux/.tmux.conf" ~/.tmux.conf
    echo "✓ Copied"
  fi
  echo
fi

# 8. Vim
if [ -f "$SNAPSHOT/vim/.vimrc" ]; then
  echo "==> Vim config found"
  if ask "Copy .vimrc to ~/.vimrc?"; then
    cp "$SNAPSHOT/vim/.vimrc" ~/.vimrc
    [ -d "$SNAPSHOT/vim/.vim" ] && cp -r "$SNAPSHOT/vim/.vim" ~/
    echo "✓ Copied"
  fi
  echo
fi

# 9. Neovim
if [ -d "$SNAPSHOT/nvim" ]; then
  echo "==> Neovim config found"
  if ask "Copy nvim config to ~/.config/nvim/?"; then
    mkdir -p ~/.config
    cp -r "$SNAPSHOT/nvim" ~/.config/
    echo "✓ Copied"
  fi
  echo
fi

# 10. asdf
if [ -f "$SNAPSHOT/env/asdf/.tool-versions" ]; then
  echo "==> asdf .tool-versions found"
  if ask "Copy .tool-versions to home directory?"; then
    cp "$SNAPSHOT/env/asdf/.tool-versions" ~/
    echo "✓ Copied"
    if command -v asdf >/dev/null 2>&1; then
      if ask "Run 'asdf install' now?"; then
        cd ~ && asdf install
      fi
    fi
  fi
  echo
fi

echo "==> Restoration complete!"
echo
echo "Manual steps remaining:"
echo "1. Review shell/sources/zsh-sources.md for plugin installation URLs"
echo "2. Set up any repo-local git configs from git/repo-local/"
echo "3. Review and apply settings from shell/essence/zshrc-essence.md"
echo "4. Check env/ directory for language-specific configs (npm, pip, etc.)"
echo "5. Review kubernetes/config if you use kubectl"
echo
echo "For full details, see: $SNAPSHOT/README.md"
